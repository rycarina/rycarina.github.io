<!DOCTYPE html>
<html>
<head>
  <title>Orbiter Drive Picker</title>
  <style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
    #picker-container { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="picker-container">
    <p>Loading Google Drive Picker...</p>
  </div>

  <script type="text/javascript">
    let apiKey = null;
    let oauthToken = null;
    let parentOrigin = null; // Will be set by the first message from parent

    // --- Google Picker API & Initialization Logic ---
    function loadPickerApi() {
      return new Promise((resolve, reject) => {
        if (typeof gapi !== 'undefined' && typeof google !== 'undefined' && google.picker) {
          console.log('External Picker: Picker API already loaded.');
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = 'https://apis.google.com/js/api.js?onload=onGoogleApiLoaded';
        script.async = true;
        script.defer = true;
        script.onerror = (e) => {
          console.error('External Picker: Error loading Google API script:', e);
          postErrorToParent('Failed to load Google API script.');
          reject(new Error('Failed to load Google API script.'));
        };
        document.head.appendChild(script);

        window.onGoogleApiLoaded = () => {
          console.log('External Picker: Google API script loaded.');
          gapi.load('picker', { 'callback': () => {
            console.log('External Picker: Google Picker API loaded.');
            resolve();
          }});
        };
      });
    }

    function createPicker() {
      if (!oauthToken) {
        console.error('External Picker: OAuth token is not available.');
        postErrorToParent('OAuth token not available for Picker.');
        document.getElementById('picker-container').innerHTML = '<p>Error: Authentication token not found.</p>';
        return;
      }
      if (!apiKey) {
        console.error('External Picker: API key is not available.');
        postErrorToParent('API key not available for Picker.');
        document.getElementById('picker-container').innerHTML = '<p>Error: API key not found.</p>';
        return;
      }

      console.log('External Picker: Creating Picker with API Key:', apiKey);
      const picker = new google.picker.PickerBuilder()
        .setAppId(apiKey) // Or your project ID if setAppId is preferred
        .setOAuthToken(oauthToken)
        .addView(google.picker.ViewId.DOCS)
        .setDeveloperKey(apiKey)
        .setCallback(pickerCallback)
        .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
        .setSize(window.innerWidth - 10, window.innerHeight - 10) 
        .build();
      picker.setVisible(true);
      
      // Clear "Loading..." message
      const container = document.getElementById('picker-container');
      if (container) container.innerHTML = ''; 
    }

    function pickerCallback(data) {
      console.log('External Picker: Picker callback data:', data);
      if (!parentOrigin) {
          console.error("External Picker: parentOrigin not set, cannot post message.");
          return;
      }
      const action = data[google.picker.Response.ACTION];
      if (action === google.picker.Action.PICKED) {
        const documents = data[google.picker.Response.DOCUMENTS];
        // Post a message to the parent window (extension's picker.html)
        window.parent.postMessage({
          type: 'PICKER_RESULT_FROM_IFRAME',
          action: 'picked',
          docs: documents 
        }, parentOrigin);
      } else if (action === google.picker.Action.CANCEL) {
        window.parent.postMessage({
          type: 'PICKER_RESULT_FROM_IFRAME',
          action: 'cancel'
        }, parentOrigin);
      } else if (action === google.picker.Action.ERROR) {
        console.error('External Picker: Picker error:', data);
         window.parent.postMessage({
          type: 'PICKER_RESULT_FROM_IFRAME',
          action: 'error',
          errorDetails: JSON.stringify(data) 
        }, parentOrigin);
      }
    }
    
    function postErrorToParent(errorMessage) {
        if (parentOrigin) {
            window.parent.postMessage({
                type: 'PICKER_IFRAME_ERROR',
                message: errorMessage
            }, parentOrigin);
        } else {
            console.warn("External Picker: Error occurred but parentOrigin not set yet:", errorMessage);
        }
         // Display error in the iframe as well
        const container = document.getElementById('picker-container');
        if (container) {
            container.innerHTML = `<p>Error: ${errorMessage}</p>`;
        }
    }

    // --- Message Handling from Parent (Extension) ---
    window.addEventListener('message', (event) => {
      // IMPORTANT: Add origin check for security
      // For now, assuming the first message comes from the trusted parent
      // and sets the origin for future communication.
      // A more robust approach would be for the parent to send its extension ID,
      // and this page could construct the expected chrome-extension://<id> origin.
      if (!parentOrigin) {
          parentOrigin = event.origin;
          console.log('External Picker: Parent origin set to:', parentOrigin);
      } else if (event.origin !== parentOrigin) {
          console.warn('External Picker: Message received from unexpected origin:', event.origin, 'Expected:', parentOrigin);
          return; // Ignore messages from unexpected origins
      }

      const data = event.data;
      console.log('External Picker: Message received from parent:', data);

      if (data && data.type === 'INIT_PICKER') {
        apiKey = data.apiKey;
        oauthToken = data.oauthToken;

        if (apiKey && oauthToken) {
          console.log('External Picker: API Key and OAuth Token received.');
          loadPickerApi().then(createPicker).catch(err => {
            console.error("External Picker: Error in loadPickerApi/createPicker chain", err);
            postErrorToParent(err.message || "Error initializing picker.");
          });
        } else {
          console.error('External Picker: Missing API Key or OAuth Token in INIT_PICKER message.');
          postErrorToParent('Missing API Key or OAuth Token from extension.');
        }
      }
    });

    console.log('External Picker: Waiting for INIT_PICKER message from parent.');
    // Optional: Send a message to parent indicating iframe is ready,
    // so parent knows when it's safe to post the INIT_PICKER message.
    // window.parent.postMessage({ type: 'IFRAME_READY' }, '*'); // Be careful with targetOrigin '*'
  </script>
</body>
</html>
